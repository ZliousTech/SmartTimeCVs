@model List<InterviewScheduleListViewModel>
@using System.Globalization
@inject Microsoft.Extensions.Localization.IStringLocalizer<SmartTimeCVs.Web.SharedResource> Localizer

@{
    var isRtl = CultureInfo.CurrentUICulture.TextInfo.IsRightToLeft;
    ViewData["Title"] = Localizer["Interview Schedules"];
    ViewData["Path"] = Localizer["Interview Schedules"];
    ViewData["Icon"] = "event";
    ViewData["ControllerName"] = "Interview";
}

@section Styles {
    <link rel="stylesheet" href="~/Theme/assets/css/plugins/dataTables.bootstrap4.min.css" />
    <style>
        .card {
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border: none;
            overflow: hidden;
        }
        /* #1DC3D2 */
        .header-teal {
            background-color: #00bcd4; /* Teal color matching screenshot */
            color: white;
            padding: 20px;
            text-align: right;
        }
        .header-teal h2 {
            margin: 0;
            font-size: 24px;
            font-weight: bold;
            color: white;
        }
        .table thead th {
            text-align: center;
            font-weight: bold;
            border-bottom: 2px solid #dee2e6;
            vertical-align: middle;
        }
        .table tbody td {
            text-align: center;
            vertical-align: middle;
        }
        /* Custom badge styles */
        .badge-status-scheduled { background-color: #ffc107; color: #212529; }
        .badge-status-confirmed { background-color: #28a745; color: white; } /* Matches "Mتاح" (Available/Confirmed) green in screenshot */
        .badge-status-completed { background-color: #17a2b8; color: white; }
        .badge-status-cancelled { background-color: #dc3545; color: white; }
        
        .btn-edit-custom {
            background-color: #fd7e14; /* Orange/Yellow for Edit button */
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 15px;
            font-weight: bold;
        }
        .btn-edit-custom:hover {
            background-color: #e36d0a;
            color: white;
        }
        
        /* Modal overrides */
        .modal { z-index: 100050 !important; }
        .modal-backdrop { z-index: 100040 !important; }
    </style>
}

<div class="row clearfix">
    <div class="col-lg-12">
        <div class="card">
            <!-- Teal Header -->
            <div class="header-teal">
                <h2>@Localizer["Interview and Test Schedules"]</h2>
            </div>
            
            <div class="body">
                <div class="table-responsive">
                    <table class="table table-bordered table-hover js-basic-example dataTable" id="schedulesTable">
                        <thead>
                            <tr>
                                <th>@Localizer["Image"]</th>
                                <th>@Localizer["Full Name"]</th>
                                <th>@Localizer["Status"]</th>
                                <th>@Localizer["Application Date"]</th>
                                <th>@Localizer["Phone Number"]</th>
                                <th>@Localizer["Job Title"]</th>
                                <th>@Localizer["Interview Date"]</th>
                                <th>@Localizer["Interview Time"]</th>
                                <th>@Localizer["Test Date"]</th>
                                <th>@Localizer["Test Time"]</th>
                                <th>@Localizer["Edit"]</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model != null && Model.Any())
                            {
                                @foreach (var schedule in Model)
                                {
                                    <tr>
                                        <td>
                                            <img src="~/images/profileImages/@(schedule.CandidateImageUrl ?? "ProfileImagePlaceholder.jpg")"
                                                 class="rounded-circle" width="40" height="40" alt="@schedule.CandidateName" />
                                        </td>
                                        <td>
                                            <strong>@schedule.CandidateName</strong><br/>
                                            <small class="text-muted">@schedule.JobTitle</small>
                                        </td>
                                        <td>
                                            @{
                                                var statusClass = schedule.Status switch
                                                {
                                                    ScheduleStatus.Scheduled => "badge-status-scheduled",
                                                    ScheduleStatus.Confirmed => "badge-status-confirmed",
                                                    ScheduleStatus.Completed => "badge-status-completed",
                                                    ScheduleStatus.Cancelled => "badge-status-cancelled",
                                                    _ => "bg-secondary text-white"
                                                };
                                            }
                                            <span class="badge @statusClass p-2">@schedule.StatusDisplay</span>
                                        </td>
                                        <td>@schedule.ApplicationDate.ToString("yyyy-MM-dd")</td>
                                        <td dir="ltr">@schedule.CandidatePhone</td>
                                        <td>@schedule.JobTitle</td>
                                        <td>@schedule.InterviewDate.ToString("yyyy-MM-dd")</td>
                                        <td>@schedule.InterviewTime.ToString(@"hh\:mm")</td>
                                        <td>
                                            @(schedule.TestDate.HasValue ? schedule.TestDate.Value.ToString("yyyy-MM-dd") : "-")
                                        </td>
                                        <td>
                                            @(schedule.TestTime.HasValue ? schedule.TestTime.Value.ToString(@"hh\:mm") : "-")
                                        </td>
                                        <td>
                                            <button type="button" class="btn-edit-custom btn-sm" 
                                                    onclick="loadEditModal(@schedule.Id)">
                                                <i class="material-icons align-middle" style="font-size: 16px;">edit</i>
                                                @Localizer["Edit"]
                                            </button>
                                        </td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Schedule Modal Container -->
<div class="modal fade" id="scheduleInterviewModal" tabindex="-1" role="dialog" aria-labelledby="scheduleInterviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content" id="modalContent">
            <!-- Content will be loaded dynamically -->
        </div>
    </div>
</div>

@section Plugins {
    <script src="~/Theme/assets/js/bundles/datatablescripts.bundle.js"></script>
}

@section Scripts {
    <script>
        $(document).ready(function() {
            var table = $('#schedulesTable').DataTable({
                responsive: true,
                order: [[6, 'asc'], [7, 'asc']], // Sort by interview date and time (columns 6 and 7)
                language: {
                    search: "@Localizer["Search:"]",
                    lengthMenu: "@Localizer["Show _MENU_ entries"]",
                    info: "@Localizer["Showing _START_ to _END_ of _TOTAL_ entries"]",
                    paginate: {
                        first: "@Localizer["First"]",
                        last: "@Localizer["Last"]",
                        next: "@Localizer["Next"]",
                        previous: "@Localizer["Previous"]"
                    },
                    emptyTable: "@Localizer["No scheduled interviews found"]"
                }
            });

            // Move modal to body to avoid z-index/stacking context issues
            $('#scheduleInterviewModal').appendTo("body");
        });

        // Function to load the edit modal
        function loadEditModal(scheduleId) {
            $.ajax({
                url: '@Url.Action("GetEditScheduleModal", "Interview")',
                type: 'GET',
                data: { id: scheduleId },
                beforeSend: function() {
                    $('#modalContent').html('<div class="modal-body text-center py-5"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Loading...</p></div>');
                    $('#scheduleInterviewModal').modal('show');
                },
                success: function(response) {
                    $('#modalContent').html(response);
                    bindUpdateButton();
                },
                error: function(xhr, status, error) {
                    Swal.fire({
                        icon: 'error',
                        title: '@Localizer["Error"]',
                        text: '@Localizer["Failed to load schedule details."]',
                        confirmButtonColor: '#dc3545'
                    });
                }
            });
        }

        // Bind update button click event
        function bindUpdateButton() {
            $('#btnUpdateSchedule').off('click').on('click', function() {
                var form = $('#editScheduleForm');
                
                // Validate required fields
                if (!form[0].checkValidity()) {
                    form[0].reportValidity();
                    return;
                }
                
                // Collect form data
                var formData = {
                    Id: parseInt($('input[name="Id"]').val()),
                    JobApplicationId: parseInt($('input[name="JobApplicationId"]').val()),
                    InterviewDate: $('#EditInterviewDate').val(),
                    InterviewTime: $('#EditInterviewTime').val() + ':00',
                    InterviewLocation: $('#EditInterviewLocation').val(),
                    TestDate: $('#EditTestDate').val() || null,
                    TestTime: $('#EditTestTime').val() ? $('#EditTestTime').val() + ':00' : null,
                    NotificationType: parseInt($('input[name="NotificationType"]:checked').val()),
                    Notes: $('#EditNotes').val()
                };
                
                // Disable button and show loading
                var btn = $('#btnUpdateSchedule');
                var originalText = btn.html();
                btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm mr-2" role="status"></span>@Localizer["Saving..."]');
                
                // Send AJAX request
                $.ajax({
                    url: '@Url.Action("UpdateSchedule", "Interview")',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(formData),
                    headers: {
                        // 'RequestVerificationToken': ... if enabled
                    },
                    success: function(response) {
                        if (response.success) {
                            Swal.fire({
                                icon: 'success',
                                title: '@Localizer["Success!"]',
                                text: response.message,
                                confirmButtonColor: '#198754'
                            }).then(function() {
                                window.location.reload();
                            });
                            $('#scheduleInterviewModal').modal('hide');
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: '@Localizer["Error"]',
                                text: response.message,
                                confirmButtonColor: '#dc3545'
                            });
                            btn.prop('disabled', false).html(originalText);
                        }
                    },
                    error: function(xhr, status, error) {
                        Swal.fire({
                            icon: 'error',
                            title: '@Localizer["Error"]',
                            text: '@Localizer["An unexpected error occurred."]',
                            confirmButtonColor: '#dc3545'
                        });
                        btn.prop('disabled', false).html(originalText);
                    }
                });
            });
        }
    </script>
}
